"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const client_rds_data_1 = require("@aws-sdk/client-rds-data");
const openai_1 = __importDefault(require("openai"));
const client_bedrock_runtime_1 = require("@aws-sdk/client-bedrock-runtime");
const rdsClient = new client_rds_data_1.RDSData({});
// Get settings from environment or database
async function getEmbeddingSettings() {
    // TODO: Consider migrating API keys to AWS Secrets Manager instead of database storage
    // This would provide better security through encryption at rest and access control
    const result = await rdsClient.executeStatement({
        resourceArn: process.env.DB_CLUSTER_ARN,
        secretArn: process.env.DB_SECRET_ARN,
        database: process.env.DB_NAME || 'aistudio',
        sql: `SELECT key, value FROM settings WHERE category = 'embeddings' OR key IN ('OPENAI_API_KEY', 'BEDROCK_ACCESS_KEY_ID', 'BEDROCK_SECRET_ACCESS_KEY', 'BEDROCK_REGION', 'AZURE_OPENAI_KEY', 'AZURE_OPENAI_ENDPOINT')`
    });
    const settings = {};
    for (const record of result.records || []) {
        if (record[0]?.stringValue && record[1]?.stringValue) {
            settings[record[0].stringValue] = record[1].stringValue;
        }
    }
    return {
        provider: settings.EMBEDDING_MODEL_PROVIDER || 'openai',
        modelId: settings.EMBEDDING_MODEL_ID || 'text-embedding-3-small',
        dimensions: parseInt(settings.EMBEDDING_DIMENSIONS || '1536', 10),
        batchSize: parseInt(settings.EMBEDDING_BATCH_SIZE || '100', 10),
        openAIKey: settings.OPENAI_API_KEY,
        bedrockAccessKey: settings.BEDROCK_ACCESS_KEY_ID,
        bedrockSecretKey: settings.BEDROCK_SECRET_ACCESS_KEY,
        bedrockRegion: settings.BEDROCK_REGION,
        azureKey: settings.AZURE_OPENAI_KEY,
        azureEndpoint: settings.AZURE_OPENAI_ENDPOINT
    };
}
// Generate embeddings based on provider
async function generateEmbeddings(texts, settings) {
    switch (settings.provider) {
        case 'openai': {
            if (!settings.openAIKey) {
                throw new Error('OpenAI API key not configured');
            }
            const openai = new openai_1.default({ apiKey: settings.openAIKey });
            const embeddings = [];
            // Process in batches
            for (let i = 0; i < texts.length; i += settings.batchSize) {
                const batch = texts.slice(i, i + settings.batchSize);
                const response = await openai.embeddings.create({
                    model: settings.modelId,
                    input: batch
                });
                embeddings.push(...response.data.map((item) => item.embedding));
            }
            return embeddings;
        }
        case 'bedrock': {
            if (!settings.bedrockAccessKey || !settings.bedrockSecretKey) {
                throw new Error('Bedrock credentials not configured');
            }
            const client = new client_bedrock_runtime_1.BedrockRuntimeClient({
                region: settings.bedrockRegion || 'us-east-1',
                credentials: {
                    accessKeyId: settings.bedrockAccessKey,
                    secretAccessKey: settings.bedrockSecretKey
                }
            });
            const embeddings = [];
            // Bedrock requires individual requests
            for (const text of texts) {
                const command = new client_bedrock_runtime_1.InvokeModelCommand({
                    modelId: settings.modelId,
                    contentType: 'application/json',
                    accept: 'application/json',
                    body: JSON.stringify({
                        inputText: text
                    })
                });
                const response = await client.send(command);
                const result = JSON.parse(new TextDecoder().decode(response.body));
                embeddings.push(result.embedding);
            }
            return embeddings;
        }
        case 'azure': {
            if (!settings.azureKey || !settings.azureEndpoint) {
                throw new Error('Azure OpenAI not configured');
            }
            // Azure OpenAI uses the same API as OpenAI
            const openai = new openai_1.default({
                apiKey: settings.azureKey,
                baseURL: `${settings.azureEndpoint}/openai/deployments/${settings.modelId}`,
                defaultHeaders: {
                    'api-key': settings.azureKey
                },
                defaultQuery: {
                    'api-version': '2024-02-15-preview'
                }
            });
            const embeddings = [];
            for (let i = 0; i < texts.length; i += settings.batchSize) {
                const batch = texts.slice(i, i + settings.batchSize);
                const response = await openai.embeddings.create({
                    model: settings.modelId,
                    input: batch
                });
                embeddings.push(...response.data.map((item) => item.embedding));
            }
            return embeddings;
        }
        default:
            throw new Error(`Unsupported embedding provider: ${settings.provider}`);
    }
}
// Retry utility with exponential backoff
async function retryWithBackoff(fn, maxRetries = 3, baseDelay = 1000) {
    let lastError;
    for (let attempt = 0; attempt < maxRetries; attempt++) {
        try {
            return await fn();
        }
        catch (error) {
            lastError = error;
            // Don't retry on non-retryable errors
            if (error instanceof Error &&
                (error.message.includes('Invalid API key') ||
                    error.message.includes('quota exceeded'))) {
                throw error;
            }
            if (attempt < maxRetries - 1) {
                const delay = baseDelay * Math.pow(2, attempt);
                console.log(`Retry attempt ${attempt + 1} after ${delay}ms delay`);
                await new Promise(resolve => setTimeout(resolve, delay));
            }
        }
    }
    throw lastError;
}
async function handler(event) {
    console.log('Processing embedding requests:', event.Records.length);
    // Updated: 2025-07-30 - Fixed embedding column name
    const settings = await getEmbeddingSettings();
    for (const record of event.Records) {
        try {
            await processRecord(record, settings);
        }
        catch (error) {
            console.error('Error processing record:', error);
            // Re-throw to let SQS retry
            throw error;
        }
    }
}
async function processRecord(record, settings) {
    const message = JSON.parse(record.body);
    console.log(`Processing embeddings for item ${message.itemId} with ${message.chunkIds.length} chunks`);
    try {
        // Generate embeddings with retry logic
        const embeddings = await retryWithBackoff(() => generateEmbeddings(message.texts, settings), 3, // max retries
        2000 // base delay of 2 seconds
        );
        // Update chunks with embeddings
        for (let i = 0; i < message.chunkIds.length; i++) {
            const chunkId = message.chunkIds[i];
            const embedding = embeddings[i];
            // Store embedding as PostgreSQL array
            const embeddingStr = `[${embedding.join(',')}]`;
            console.log(`Updating chunk ${chunkId} with embedding length: ${embedding.length}`);
            console.log(`Embedding string preview: ${embeddingStr.substring(0, 50)}...`);
            await rdsClient.executeStatement({
                resourceArn: process.env.DB_CLUSTER_ARN,
                secretArn: process.env.DB_SECRET_ARN,
                database: process.env.DB_NAME || 'aistudio',
                sql: 'UPDATE repository_item_chunks SET embedding = :embedding::vector WHERE id = :id',
                parameters: [
                    {
                        name: 'embedding',
                        value: { stringValue: embeddingStr }
                    },
                    {
                        name: 'id',
                        value: { longValue: chunkId }
                    }
                ]
            });
        }
        // Update item status
        await rdsClient.executeStatement({
            resourceArn: process.env.DB_CLUSTER_ARN,
            secretArn: process.env.DB_SECRET_ARN,
            database: process.env.DB_NAME || 'aistudio',
            sql: `UPDATE repository_items 
            SET processing_status = 'embedded', 
                updated_at = CURRENT_TIMESTAMP 
            WHERE id = :id`,
            parameters: [
                {
                    name: 'id',
                    value: { longValue: message.itemId }
                }
            ]
        });
        console.log(`Successfully generated embeddings for item ${message.itemId}`);
    }
    catch (error) {
        console.error(`Failed to generate embeddings for item ${message.itemId}:`, error);
        // Update item with error
        await rdsClient.executeStatement({
            resourceArn: process.env.DB_CLUSTER_ARN,
            secretArn: process.env.DB_SECRET_ARN,
            database: process.env.DB_NAME || 'aistudio',
            sql: `UPDATE repository_items 
            SET processing_status = 'embedding_failed', 
                processing_error = :error,
                updated_at = CURRENT_TIMESTAMP 
            WHERE id = :id`,
            parameters: [
                {
                    name: 'id',
                    value: { longValue: message.itemId }
                },
                {
                    name: 'error',
                    value: { stringValue: error.message }
                }
            ]
        });
        throw error;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7OztBQTZLQSwwQkFlQztBQTNMRCw4REFBa0Q7QUFDbEQsb0RBQTJCO0FBQzNCLDRFQUEwRjtBQUUxRixNQUFNLFNBQVMsR0FBRyxJQUFJLHlCQUFPLENBQUMsRUFBRSxDQUFDLENBQUE7QUFFakMsNENBQTRDO0FBQzVDLEtBQUssVUFBVSxvQkFBb0I7SUFDakMsdUZBQXVGO0lBQ3ZGLG1GQUFtRjtJQUNuRixNQUFNLE1BQU0sR0FBRyxNQUFNLFNBQVMsQ0FBQyxnQkFBZ0IsQ0FBQztRQUM5QyxXQUFXLEVBQUUsT0FBTyxDQUFDLEdBQUcsQ0FBQyxjQUFlO1FBQ3hDLFNBQVMsRUFBRSxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWM7UUFDckMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxHQUFHLENBQUMsT0FBTyxJQUFJLFVBQVU7UUFDM0MsR0FBRyxFQUFFLGlOQUFpTjtLQUN2TixDQUFDLENBQUE7SUFFRixNQUFNLFFBQVEsR0FBMkIsRUFBRSxDQUFBO0lBQzNDLEtBQUssTUFBTSxNQUFNLElBQUksTUFBTSxDQUFDLE9BQU8sSUFBSSxFQUFFLEVBQUUsQ0FBQztRQUMxQyxJQUFJLE1BQU0sQ0FBQyxDQUFDLENBQUMsRUFBRSxXQUFXLElBQUksTUFBTSxDQUFDLENBQUMsQ0FBQyxFQUFFLFdBQVcsRUFBRSxDQUFDO1lBQ3JELFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQyxDQUFDLENBQUMsV0FBVyxDQUFDLEdBQUcsTUFBTSxDQUFDLENBQUMsQ0FBQyxDQUFDLFdBQVcsQ0FBQTtRQUN6RCxDQUFDO0lBQ0gsQ0FBQztJQUVELE9BQU87UUFDTCxRQUFRLEVBQUUsUUFBUSxDQUFDLHdCQUF3QixJQUFJLFFBQVE7UUFDdkQsT0FBTyxFQUFFLFFBQVEsQ0FBQyxrQkFBa0IsSUFBSSx3QkFBd0I7UUFDaEUsVUFBVSxFQUFFLFFBQVEsQ0FBQyxRQUFR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b0JBQ0UsSUFBSSxFQUFFLE9BQU87b0JBQ2IsS0FBSyxFQUFFLEVBQUUsV0FBVyxFQUFHLEtBQWUsQ0FBQyxPQUFPLEVBQUU7aUJBQ2pEO2FBQ0Y7U0FDRixDQUFDLENBQUE7UUFFRixNQUFNLEtBQUssQ0FBQTtJQUNiLENBQUM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU1FTRXZlbnQsIFNRU1JlY29yZCB9IGZyb20gJ2F3cy1sYW1iZGEnXG5pbXBvcnQgeyBSRFNEYXRhIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXJkcy1kYXRhJ1xuaW1wb3J0IE9wZW5BSSBmcm9tICdvcGVuYWknXG5pbXBvcnQgeyBCZWRyb2NrUnVudGltZUNsaWVudCwgSW52b2tlTW9kZWxDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LWJlZHJvY2stcnVudGltZSdcblxuY29uc3QgcmRzQ2xpZW50ID0gbmV3IFJEU0RhdGEoe30pXG5cbi8vIEdldCBzZXR0aW5ncyBmcm9tIGVudmlyb25tZW50IG9yIGRhdGFiYXNlXG5hc3luYyBmdW5jdGlvbiBnZXRFbWJlZGRpbmdTZXR0aW5ncygpIHtcbiAgLy8gVE9ETzogQ29uc2lkZXIgbWlncmF0aW5nIEFQSSBrZXlzIHRvIEFXUyBTZWNyZXRzIE1hbmFnZXIgaW5zdGVhZCBvZiBkYXRhYmFzZSBzdG9yYWdlXG4gIC8vIFRoaXMgd291bGQgcHJvdmlkZSBiZXR0ZXIgc2VjdXJpdHkgdGhyb3VnaCBlbmNyeXB0aW9uIGF0IHJlc3QgYW5kIGFjY2VzcyBjb250cm9sXG4gIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJkc0NsaWVudC5leGVjdXRlU3RhdGVtZW50KHtcbiAgICByZXNvdXJjZUFybjogcHJvY2Vzcy5lbnYuREJfQ0xVU1RFUl9BUk4hLFxuICAgIHNlY3JldEFybjogcHJvY2Vzcy5lbnYuREJfU0VDUkVUX0FSTiEsXG4gICAgZGF0YWJhc2U6IHByb2Nlc3MuZW52LkRCX05BTUUgfHwgJ2Fpc3R1ZGlvJyxcbiAgICBzcWw6IGBTRUxFQ1Qga2V5LCB2YWx1ZSBGUk9NIHNldHRpbmdzIFdIRVJFIGNhdGVnb3J5ID0gJ2VtYmVkZGluZ3MnIE9SIGtleSBJTiAoJ09QRU5BSV9BUElfS0VZJywgJ0JFRFJPQ0tfQUNDRVNTX0tFWV9JRCcsICdCRURST0NLX1NFQ1JFVF9BQ0NFU1NfS0VZJywgJ0JFRFJPQ0tfUkVHSU9OJywgJ0FaVVJFX09QRU5BSV9LRVknLCAnQVpVUkVfT1BFTkFJX0VORFBPSU5UJylgXG4gIH0pXG5cbiAgY29uc3Qgc2V0dGluZ3M6IFJlY29yZDxzdHJpbmcsIHN0cmluZz4gPSB7fVxuICBmb3IgKGNvbnN0IHJlY29yZCBvZiByZXN1bHQucmVjb3JkcyB8fCBbXSkge1xuICAgIGlmIChyZWNvcmRbMF0/LnN0cmluZ1ZhbHVlICYmIHJlY29yZFsxXT8uc3RyaW5nVmFsdWUpIHtcbiAgICAgIHNldHRpbmdzW3JlY29yZFswXS5zdHJpbmdWYWx1ZV0gPSByZWNvcmRbMV0uc3RyaW5nVmFsdWVcbiAgICB9XG4gIH1cblxuICByZXR1cm4ge1xuICAgIHByb3ZpZGVyOiBzZXR0aW5ncy5FTUJFRERJTkdfTU9ERUxfUFJPVklERVIgfHwgJ29wZW5haScsXG4gICAgbW9kZWxJZDogc2V0dGluZ3MuRU1CRURESU5HX01PREVMX0lEIHx8ICd0ZXh0LWVtYmVkZGluZy0zLXNtYWxsJyxcbiAgICBkaW1lbnNpb25zOiBwYXJzZUludChzZXR0aW5ncy5FTUJFRERJTkdfRElNRU5TSU9OUyB8fCAnMTUzNicsIDEwKSxcbiAgICBiYXRjaFNpemU6IHBhcnNlSW50KHNldHRpbmdzLkVNQkVERElOR19CQVRDSF9TSVpFIHx8ICcxMDAnLCAxMCksXG4gICAgb3BlbkFJS2V5OiBzZXR0aW5ncy5PUEVOQUlfQVBJX0tFWSxcbiAgICBiZWRyb2NrQWNjZXNzS2V5OiBzZXR0aW5ncy5CRURST0NLX0FDQ0VTU19LRVlfSUQsXG4gICAgYmVkcm9ja1NlY3JldEtleTogc2V0dGluZ3MuQkVEUk9DS19TRUNSRVRfQUNDRVNTX0tFWSxcbiAgICBiZWRyb2NrUmVnaW9uOiBzZXR0aW5ncy5CRURST0NLX1JFR0lPTixcbiAgICBhenVyZUtleTogc2V0dGluZ3MuQVpVUkVfT1BFTkFJX0tFWSxcbiAgICBhenVyZUVuZHBvaW50OiBzZXR0aW5ncy5BWlVSRV9PUEVOQUlfRU5EUE9JTlRcbiAgfVxufVxuXG4vLyBHZW5lcmF0ZSBlbWJlZGRpbmdzIGJhc2VkIG9uIHByb3ZpZGVyXG5hc3luYyBmdW5jdGlvbiBnZW5lcmF0ZUVtYmVkZGluZ3ModGV4dHM6IHN0cmluZ1tdLCBzZXR0aW5nczogYW55KTogUHJvbWlzZTxudW1iZXJbXVtdPiB7XG4gIHN3aXRjaCAoc2V0dGluZ3MucHJvdmlkZXIpIHtcbiAgICBjYXNlICdvcGVuYWknOiB7XG4gICAgICBpZiAoIXNldHRpbmdzLm9wZW5BSUtleSkge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ09wZW5BSSBBUEkga2V5IG5vdCBjb25maWd1cmVkJylcbiAgICAgIH1cblxuICAgICAgY29uc3Qgb3BlbmFpID0gbmV3IE9wZW5BSSh7IGFwaUtleTogc2V0dGluZ3Mub3BlbkFJS2V5IH0pXG4gICAgICBjb25zdCBlbWJlZGRpbmdzOiBudW1iZXJbXVtdID0gW11cblxuICAgICAgLy8gUHJvY2VzcyBpbiBiYXRjaGVzXG4gICAgICBmb3IgKGxldCBpID0gMDsgaSA8IHRleHRzLmxlbmd0aDsgaSArPSBzZXR0aW5ncy5iYXRjaFNpemUpIHtcbiAgICAgICAgY29uc3QgYmF0Y2ggPSB0ZXh0cy5zbGljZShpLCBpICsgc2V0dGluZ3MuYmF0Y2hTaXplKVxuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IG9wZW5haS5lbWJlZGRpbmdzLmNyZWF0ZSh7XG4gICAgICAgICAgbW9kZWw6IHNldHRpbmdzLm1vZGVsSWQsXG4gICAgICAgICAgaW5wdXQ6IGJhdGNoXG4gICAgICAgIH0pXG5cbiAgICAgICAgZW1iZWRkaW5ncy5wdXNoKC4uLnJlc3BvbnNlLmRhdGEubWFwKChpdGVtOiBhbnkpID0+IGl0ZW0uZW1iZWRkaW5nKSlcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGVtYmVkZGluZ3NcbiAgICB9XG5cbiAgICBjYXNlICdiZWRyb2NrJzoge1xuICAgICAgaWYgKCFzZXR0aW5ncy5iZWRyb2NrQWNjZXNzS2V5IHx8ICFzZXR0aW5ncy5iZWRyb2NrU2VjcmV0S2V5KSB7XG4gICAgICAgIHRocm93IG5ldyBFcnJvcignQmVkcm9jayBjcmVkZW50aWFscyBub3QgY29uZmlndXJlZCcpXG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGNsaWVudCA9IG5ldyBCZWRyb2NrUnVudGltZUNsaWVudCh7XG4gICAgICAgIHJlZ2lvbjogc2V0dGluZ3MuYmVkcm9ja1JlZ2lvbiB8fCAndXMtZWFzdC0xJyxcbiAgICAgICAgY3JlZGVudGlhbHM6IHtcbiAgICAgICAgICBhY2Nlc3NLZXlJZDogc2V0dGluZ3MuYmVkcm9ja0FjY2Vzc0tleSxcbiAgICAgICAgICBzZWNyZXRBY2Nlc3NLZXk6IHNldHRpbmdzLmJlZHJvY2tTZWNyZXRLZXlcbiAgICAgICAgfVxuICAgICAgfSlcblxuICAgICAgY29uc3QgZW1iZWRkaW5nczogbnVtYmVyW11bXSA9IFtdXG5cbiAgICAgIC8vIEJlZHJvY2sgcmVxdWlyZXMgaW5kaXZpZHVhbCByZXF1ZXN0c1xuICAgICAgZm9yIChjb25zdCB0ZXh0IG9mIHRleHRzKSB7XG4gICAgICAgIGNvbnN0IGNvbW1hbmQgPSBuZXcgSW52b2tlTW9kZWxDb21tYW5kKHtcbiAgICAgICAgICBtb2RlbElkOiBzZXR0aW5ncy5tb2RlbElkLFxuICAgICAgICAgIGNvbnRlbnRUeXBlOiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgYWNjZXB0OiAnYXBwbGljYXRpb24vanNvbicsXG4gICAgICAgICAgYm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgICAgaW5wdXRUZXh0OiB0ZXh0XG4gICAgICAgICAgfSlcbiAgICAgICAgfSlcblxuICAgICAgICBjb25zdCByZXNwb25zZSA9IGF3YWl0IGNsaWVudC5zZW5kKGNvbW1hbmQpXG4gICAgICAgIGNvbnN0IHJlc3VsdCA9IEpTT04ucGFyc2UobmV3IFRleHREZWNvZGVyKCkuZGVjb2RlKHJlc3BvbnNlLmJvZHkpKVxuICAgICAgICBlbWJlZGRpbmdzLnB1c2gocmVzdWx0LmVtYmVkZGluZylcbiAgICAgIH1cblxuICAgICAgcmV0dXJuIGVtYmVkZGluZ3NcbiAgICB9XG5cbiAgICBjYXNlICdhenVyZSc6IHtcbiAgICAgIGlmICghc2V0dGluZ3MuYXp1cmVLZXkgfHwgIXNldHRpbmdzLmF6dXJlRW5kcG9pbnQpIHtcbiAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdBenVyZSBPcGVuQUkgbm90IGNvbmZpZ3VyZWQnKVxuICAgICAgfVxuXG4gICAgICAvLyBBenVyZSBPcGVuQUkgdXNlcyB0aGUgc2FtZSBBUEkgYXMgT3BlbkFJXG4gICAgICBjb25zdCBvcGVuYWkgPSBuZXcgT3BlbkFJKHtcbiAgICAgICAgYXBpS2V5OiBzZXR0aW5ncy5henVyZUtleSxcbiAgICAgICAgYmFzZVVSTDogYCR7c2V0dGluZ3MuYXp1cmVFbmRwb2ludH0vb3BlbmFpL2RlcGxveW1lbnRzLyR7c2V0dGluZ3MubW9kZWxJZH1gLFxuICAgICAgICBkZWZhdWx0SGVhZGVyczoge1xuICAgICAgICAgICdhcGkta2V5Jzogc2V0dGluZ3MuYXp1cmVLZXlcbiAgICAgICAgfSxcbiAgICAgICAgZGVmYXVsdFF1ZXJ5OiB7XG4gICAgICAgICAgJ2FwaS12ZXJzaW9uJzogJzIwMjQtMDItMTUtcHJldmlldydcbiAgICAgICAgfVxuICAgICAgfSlcblxuICAgICAgY29uc3QgZW1iZWRkaW5nczogbnVtYmVyW11bXSA9IFtdXG5cbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGV4dHMubGVuZ3RoOyBpICs9IHNldHRpbmdzLmJhdGNoU2l6ZSkge1xuICAgICAgICBjb25zdCBiYXRjaCA9IHRleHRzLnNsaWNlKGksIGkgKyBzZXR0aW5ncy5iYXRjaFNpemUpXG4gICAgICAgIGNvbnN0IHJlc3BvbnNlID0gYXdhaXQgb3BlbmFpLmVtYmVkZGluZ3MuY3JlYXRlKHtcbiAgICAgICAgICBtb2RlbDogc2V0dGluZ3MubW9kZWxJZCxcbiAgICAgICAgICBpbnB1dDogYmF0Y2hcbiAgICAgICAgfSlcblxuICAgICAgICBlbWJlZGRpbmdzLnB1c2goLi4ucmVzcG9uc2UuZGF0YS5tYXAoKGl0ZW06IGFueSkgPT4gaXRlbS5lbWJlZGRpbmcpKVxuICAgICAgfVxuXG4gICAgICByZXR1cm4gZW1iZWRkaW5nc1xuICAgIH1cblxuICAgIGRlZmF1bHQ6XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYFVuc3VwcG9ydGVkIGVtYmVkZGluZyBwcm92aWRlcjogJHtzZXR0aW5ncy5wcm92aWRlcn1gKVxuICB9XG59XG5cbmludGVyZmFjZSBFbWJlZGRpbmdNZXNzYWdlIHtcbiAgaXRlbUlkOiBudW1iZXJcbiAgY2h1bmtJZHM6IG51bWJlcltdXG4gIHRleHRzOiBzdHJpbmdbXVxufVxuXG4vLyBSZXRyeSB1dGlsaXR5IHdpdGggZXhwb25lbnRpYWwgYmFja29mZlxuYXN5bmMgZnVuY3Rpb24gcmV0cnlXaXRoQmFja29mZjxUPihcbiAgZm46ICgpID0+IFByb21pc2U8VD4sXG4gIG1heFJldHJpZXM6IG51bWJlciA9IDMsXG4gIGJhc2VEZWxheTogbnVtYmVyID0gMTAwMFxuKTogUHJvbWlzZTxUPiB7XG4gIGxldCBsYXN0RXJyb3I6IGFueTtcbiAgXG4gIGZvciAobGV0IGF0dGVtcHQgPSAwOyBhdHRlbXB0IDwgbWF4UmV0cmllczsgYXR0ZW1wdCsrKSB7XG4gICAgdHJ5IHtcbiAgICAgIHJldHVybiBhd2FpdCBmbigpO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBsYXN0RXJyb3IgPSBlcnJvcjtcbiAgICAgIFxuICAgICAgLy8gRG9uJ3QgcmV0cnkgb24gbm9uLXJldHJ5YWJsZSBlcnJvcnNcbiAgICAgIGlmIChlcnJvciBpbnN0YW5jZW9mIEVycm9yICYmIFxuICAgICAgICAgIChlcnJvci5tZXNzYWdlLmluY2x1ZGVzKCdJbnZhbGlkIEFQSSBrZXknKSB8fCBcbiAgICAgICAgICAgZXJyb3IubWVzc2FnZS5pbmNsdWRlcygncXVvdGEgZXhjZWVkZWQnKSkpIHtcbiAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICB9XG4gICAgICBcbiAgICAgIGlmIChhdHRlbXB0IDwgbWF4UmV0cmllcyAtIDEpIHtcbiAgICAgICAgY29uc3QgZGVsYXkgPSBiYXNlRGVsYXkgKiBNYXRoLnBvdygyLCBhdHRlbXB0KTtcbiAgICAgICAgY29uc29sZS5sb2coYFJldHJ5IGF0dGVtcHQgJHthdHRlbXB0ICsgMX0gYWZ0ZXIgJHtkZWxheX1tcyBkZWxheWApO1xuICAgICAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgZGVsYXkpKTtcbiAgICAgIH1cbiAgICB9XG4gIH1cbiAgXG4gIHRocm93IGxhc3RFcnJvcjtcbn1cblxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGhhbmRsZXIoZXZlbnQ6IFNRU0V2ZW50KSB7XG4gIGNvbnNvbGUubG9nKCdQcm9jZXNzaW5nIGVtYmVkZGluZyByZXF1ZXN0czonLCBldmVudC5SZWNvcmRzLmxlbmd0aClcbiAgLy8gVXBkYXRlZDogMjAyNS0wNy0zMCAtIEZpeGVkIGVtYmVkZGluZyBjb2x1bW4gbmFtZVxuXG4gIGNvbnN0IHNldHRpbmdzID0gYXdhaXQgZ2V0RW1iZWRkaW5nU2V0dGluZ3MoKVxuXG4gIGZvciAoY29uc3QgcmVjb3JkIG9mIGV2ZW50LlJlY29yZHMpIHtcbiAgICB0cnkge1xuICAgICAgYXdhaXQgcHJvY2Vzc1JlY29yZChyZWNvcmQsIHNldHRpbmdzKVxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBwcm9jZXNzaW5nIHJlY29yZDonLCBlcnJvcilcbiAgICAgIC8vIFJlLXRocm93IHRvIGxldCBTUVMgcmV0cnlcbiAgICAgIHRocm93IGVycm9yXG4gICAgfVxuICB9XG59XG5cbmFzeW5jIGZ1bmN0aW9uIHByb2Nlc3NSZWNvcmQocmVjb3JkOiBTUVNSZWNvcmQsIHNldHRpbmdzOiBhbnkpIHtcbiAgY29uc3QgbWVzc2FnZTogRW1iZWRkaW5nTWVzc2FnZSA9IEpTT04ucGFyc2UocmVjb3JkLmJvZHkpXG4gIGNvbnNvbGUubG9nKGBQcm9jZXNzaW5nIGVtYmVkZGluZ3MgZm9yIGl0ZW0gJHttZXNzYWdlLml0ZW1JZH0gd2l0aCAke21lc3NhZ2UuY2h1bmtJZHMubGVuZ3RofSBjaHVua3NgKVxuXG4gIHRyeSB7XG4gICAgLy8gR2VuZXJhdGUgZW1iZWRkaW5ncyB3aXRoIHJldHJ5IGxvZ2ljXG4gICAgY29uc3QgZW1iZWRkaW5ncyA9IGF3YWl0IHJldHJ5V2l0aEJhY2tvZmYoXG4gICAgICAoKSA9PiBnZW5lcmF0ZUVtYmVkZGluZ3MobWVzc2FnZS50ZXh0cywgc2V0dGluZ3MpLFxuICAgICAgMywgLy8gbWF4IHJldHJpZXNcbiAgICAgIDIwMDAgLy8gYmFzZSBkZWxheSBvZiAyIHNlY29uZHNcbiAgICApXG5cbiAgICAvLyBVcGRhdGUgY2h1bmtzIHdpdGggZW1iZWRkaW5nc1xuICAgIGZvciAobGV0IGkgPSAwOyBpIDwgbWVzc2FnZS5jaHVua0lkcy5sZW5ndGg7IGkrKykge1xuICAgICAgY29uc3QgY2h1bmtJZCA9IG1lc3NhZ2UuY2h1bmtJZHNbaV1cbiAgICAgIGNvbnN0IGVtYmVkZGluZyA9IGVtYmVkZGluZ3NbaV1cblxuICAgICAgLy8gU3RvcmUgZW1iZWRkaW5nIGFzIFBvc3RncmVTUUwgYXJyYXlcbiAgICAgIGNvbnN0IGVtYmVkZGluZ1N0ciA9IGBbJHtlbWJlZGRpbmcuam9pbignLCcpfV1gXG4gICAgICBcbiAgICAgIGNvbnNvbGUubG9nKGBVcGRhdGluZyBjaHVuayAke2NodW5rSWR9IHdpdGggZW1iZWRkaW5nIGxlbmd0aDogJHtlbWJlZGRpbmcubGVuZ3RofWApXG4gICAgICBjb25zb2xlLmxvZyhgRW1iZWRkaW5nIHN0cmluZyBwcmV2aWV3OiAke2VtYmVkZGluZ1N0ci5zdWJzdHJpbmcoMCwgNTApfS4uLmApXG5cbiAgICAgIGF3YWl0IHJkc0NsaWVudC5leGVjdXRlU3RhdGVtZW50KHtcbiAgICAgICAgcmVzb3VyY2VBcm46IHByb2Nlc3MuZW52LkRCX0NMVVNURVJfQVJOISxcbiAgICAgICAgc2VjcmV0QXJuOiBwcm9jZXNzLmVudi5EQl9TRUNSRVRfQVJOISxcbiAgICAgICAgZGF0YWJhc2U6IHByb2Nlc3MuZW52LkRCX05BTUUgfHwgJ2Fpc3R1ZGlvJyxcbiAgICAgICAgc3FsOiAnVVBEQVRFIHJlcG9zaXRvcnlfaXRlbV9jaHVua3MgU0VUIGVtYmVkZGluZyA9IDplbWJlZGRpbmc6OnZlY3RvciBXSEVSRSBpZCA9IDppZCcsXG4gICAgICAgIHBhcmFtZXRlcnM6IFtcbiAgICAgICAgICB7XG4gICAgICAgICAgICBuYW1lOiAnZW1iZWRkaW5nJyxcbiAgICAgICAgICAgIHZhbHVlOiB7IHN0cmluZ1ZhbHVlOiBlbWJlZGRpbmdTdHIgfVxuICAgICAgICAgIH0sXG4gICAgICAgICAge1xuICAgICAgICAgICAgbmFtZTogJ2lkJyxcbiAgICAgICAgICAgIHZhbHVlOiB7IGxvbmdWYWx1ZTogY2h1bmtJZCB9XG4gICAgICAgICAgfVxuICAgICAgICBdXG4gICAgICB9KVxuICAgIH1cblxuICAgIC8vIFVwZGF0ZSBpdGVtIHN0YXR1c1xuICAgIGF3YWl0IHJkc0NsaWVudC5leGVjdXRlU3RhdGVtZW50KHtcbiAgICAgIHJlc291cmNlQXJuOiBwcm9jZXNzLmVudi5EQl9DTFVTVEVSX0FSTiEsXG4gICAgICBzZWNyZXRBcm46IHByb2Nlc3MuZW52LkRCX1NFQ1JFVF9BUk4hLFxuICAgICAgZGF0YWJhc2U6IHByb2Nlc3MuZW52LkRCX05BTUUgfHwgJ2Fpc3R1ZGlvJyxcbiAgICAgIHNxbDogYFVQREFURSByZXBvc2l0b3J5X2l0ZW1zIFxuICAgICAgICAgICAgU0VUIHByb2Nlc3Npbmdfc3RhdHVzID0gJ2VtYmVkZGVkJywgXG4gICAgICAgICAgICAgICAgdXBkYXRlZF9hdCA9IENVUlJFTlRfVElNRVNUQU1QIFxuICAgICAgICAgICAgV0hFUkUgaWQgPSA6aWRgLFxuICAgICAgcGFyYW1ldGVyczogW1xuICAgICAgICB7XG4gICAgICAgICAgbmFtZTogJ2lkJyxcbiAgICAgICAgICB2YWx1ZTogeyBsb25nVmFsdWU6IG1lc3NhZ2UuaXRlbUlkIH1cbiAgICAgICAgfVxuICAgICAgXVxuICAgIH0pXG5cbiAgICBjb25zb2xlLmxvZyhgU3VjY2Vzc2Z1bGx5IGdlbmVyYXRlZCBlbWJlZGRpbmdzIGZvciBpdGVtICR7bWVzc2FnZS5pdGVtSWR9YClcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKGBGYWlsZWQgdG8gZ2VuZXJhdGUgZW1iZWRkaW5ncyBmb3IgaXRlbSAke21lc3NhZ2UuaXRlbUlkfTpgLCBlcnJvcilcblxuICAgIC8vIFVwZGF0ZSBpdGVtIHdpdGggZXJyb3JcbiAgICBhd2FpdCByZHNDbGllbnQuZXhlY3V0ZVN0YXRlbWVudCh7XG4gICAgICByZXNvdXJjZUFybjogcHJvY2Vzcy5lbnYuREJfQ0xVU1RFUl9BUk4hLFxuICAgICAgc2VjcmV0QXJuOiBwcm9jZXNzLmVudi5EQl9TRUNSRVRfQVJOISxcbiAgICAgIGRhdGFiYXNlOiBwcm9jZXNzLmVudi5EQl9OQU1FIHx8ICdhaXN0dWRpbycsXG4gICAgICBzcWw6IGBVUERBVEUgcmVwb3NpdG9yeV9pdGVtcyBcbiAgICAgICAgICAgIFNFVCBwcm9jZXNzaW5nX3N0YXR1cyA9ICdlbWJlZGRpbmdfZmFpbGVkJywgXG4gICAgICAgICAgICAgICAgcHJvY2Vzc2luZ19lcnJvciA9IDplcnJvcixcbiAgICAgICAgICAgICAgICB1cGRhdGVkX2F0ID0gQ1VSUkVOVF9USU1FU1RBTVAgXG4gICAgICAgICAgICBXSEVSRSBpZCA9IDppZGAsXG4gICAgICBwYXJhbWV0ZXJzOiBbXG4gICAgICAgIHtcbiAgICAgICAgICBuYW1lOiAnaWQnLFxuICAgICAgICAgIHZhbHVlOiB7IGxvbmdWYWx1ZTogbWVzc2FnZS5pdGVtSWQgfVxuICAgICAgICB9LFxuICAgICAgICB7XG4gICAgICAgICAgbmFtZTogJ2Vycm9yJyxcbiAgICAgICAgICB2YWx1ZTogeyBzdHJpbmdWYWx1ZTogKGVycm9yIGFzIEVycm9yKS5tZXNzYWdlIH1cbiAgICAgICAgfVxuICAgICAgXVxuICAgIH0pXG5cbiAgICB0aHJvdyBlcnJvclxuICB9XG59Il19