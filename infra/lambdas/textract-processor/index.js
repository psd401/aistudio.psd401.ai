"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.handler = handler;
const client_textract_1 = require("@aws-sdk/client-textract");
const client_rds_data_1 = require("@aws-sdk/client-rds-data");
const client_sqs_1 = require("@aws-sdk/client-sqs");
const textractClient = new client_textract_1.TextractClient({});
const rdsClient = new client_rds_data_1.RDSDataClient({});
const sqsClient = new client_sqs_1.SQSClient({});
const DATABASE_RESOURCE_ARN = process.env.DATABASE_RESOURCE_ARN;
const DATABASE_SECRET_ARN = process.env.DATABASE_SECRET_ARN;
const DATABASE_NAME = process.env.DATABASE_NAME;
const EMBEDDING_QUEUE_URL = process.env.EMBEDDING_QUEUE_URL;
// Helper function to create SQL parameters
function createSqlParameter(name, value) {
    if (value === null) {
        return { name, value: { isNull: true } };
    }
    if (typeof value === 'string') {
        return { name, value: { stringValue: value } };
    }
    if (typeof value === 'number') {
        return { name, value: { longValue: value } };
    }
    if (typeof value === 'boolean') {
        return { name, value: { booleanValue: value } };
    }
    throw new Error(`Unsupported parameter type for ${name}: ${typeof value}`);
}
// Get job metadata from DynamoDB or RDS
async function getJobMetadata(jobId) {
    try {
        const sql = `
      SELECT item_id, file_name 
      FROM textract_jobs 
      WHERE job_id = :jobId
    `;
        const result = await rdsClient.send(new client_rds_data_1.ExecuteStatementCommand({
            resourceArn: DATABASE_RESOURCE_ARN,
            secretArn: DATABASE_SECRET_ARN,
            database: DATABASE_NAME,
            sql,
            parameters: [createSqlParameter('jobId', jobId)]
        }));
        if (result.records && result.records.length > 0) {
            const record = result.records[0];
            return {
                itemId: record[0]?.longValue || 0,
                fileName: record[1]?.stringValue || ''
            };
        }
        return null;
    }
    catch (error) {
        console.error('Error getting job metadata:', error);
        return null;
    }
}
// Get document text from Textract
async function getDocumentText(jobId, useAnalysis = true) {
    let nextToken;
    let fullText = '';
    do {
        try {
            let response;
            if (useAnalysis) {
                response = await textractClient.send(new client_textract_1.GetDocumentAnalysisCommand({
                    JobId: jobId,
                    NextToken: nextToken
                }));
            }
            else {
                response = await textractClient.send(new client_textract_1.GetDocumentTextDetectionCommand({
                    JobId: jobId,
                    NextToken: nextToken
                }));
            }
            // Extract text from blocks
            if (response.Blocks) {
                for (const block of response.Blocks) {
                    if (block.BlockType === 'LINE' && block.Text) {
                        fullText += block.Text + '\n';
                    }
                }
            }
            nextToken = response.NextToken;
        }
        catch (error) {
            console.error('Error getting document text:', error);
            break;
        }
    } while (nextToken);
    return fullText.trim();
}
// Chunk text (same as file-processor)
function chunkText(text, maxChunkSize = 2000) {
    const chunks = [];
    const lines = text.split('\n');
    let currentChunk = '';
    let chunkIndex = 0;
    for (const line of lines) {
        if ((currentChunk + line).length > maxChunkSize && currentChunk.length > 0) {
            chunks.push({
                content: currentChunk.trim(),
                metadata: { lineStart: chunkIndex },
                chunkIndex: chunks.length,
                tokens: Math.ceil(currentChunk.length / 4), // Rough token estimate
            });
            currentChunk = line + '\n';
        }
        else {
            currentChunk += line + '\n';
        }
    }
    if (currentChunk.trim().length > 0) {
        chunks.push({
            content: currentChunk.trim(),
            metadata: { lineStart: chunkIndex },
            chunkIndex: chunks.length,
            tokens: Math.ceil(currentChunk.length / 4),
        });
    }
    return chunks;
}
// Store chunks and queue for embeddings (similar to file-processor)
async function storeAndQueueChunks(itemId, chunks) {
    if (chunks.length === 0)
        return;
    // First, delete existing chunks
    await rdsClient.send(new client_rds_data_1.ExecuteStatementCommand({
        resourceArn: DATABASE_RESOURCE_ARN,
        secretArn: DATABASE_SECRET_ARN,
        database: DATABASE_NAME,
        sql: 'DELETE FROM repository_item_chunks WHERE item_id = :itemId',
        parameters: [createSqlParameter('itemId', itemId)],
    }));
    const chunkIds = [];
    const texts = [];
    // Batch insert new chunks
    const parameterSets = chunks.map(chunk => [
        createSqlParameter('itemId', itemId),
        createSqlParameter('content', chunk.content),
        createSqlParameter('metadata', JSON.stringify(chunk.metadata)),
        createSqlParameter('chunkIndex', chunk.chunkIndex),
        createSqlParameter('tokens', chunk.tokens ?? null),
    ]);
    const batchSize = 25;
    for (let i = 0; i < parameterSets.length; i += batchSize) {
        const batch = parameterSets.slice(i, i + batchSize);
        await rdsClient.send(new client_rds_data_1.BatchExecuteStatementCommand({
            resourceArn: DATABASE_RESOURCE_ARN,
            secretArn: DATABASE_SECRET_ARN,
            database: DATABASE_NAME,
            sql: `INSERT INTO repository_item_chunks 
              (item_id, content, metadata, chunk_index, tokens)
              VALUES (:itemId, :content, :metadata::jsonb, :chunkIndex, :tokens)`,
            parameterSets: batch,
        }));
        // Query for the inserted IDs
        const chunkResult = await rdsClient.send(new client_rds_data_1.ExecuteStatementCommand({
            resourceArn: DATABASE_RESOURCE_ARN,
            secretArn: DATABASE_SECRET_ARN,
            database: DATABASE_NAME,
            sql: `SELECT id, content FROM repository_item_chunks 
              WHERE item_id = :itemId 
              AND chunk_index >= :startIndex 
              AND chunk_index < :endIndex
              ORDER BY chunk_index`,
            parameters: [
                createSqlParameter('itemId', itemId),
                createSqlParameter('startIndex', i),
                createSqlParameter('endIndex', i + batch.length)
            ]
        }));
        if (chunkResult.records) {
            chunkResult.records.forEach(record => {
                if (record[0]?.longValue && record[1]?.stringValue) {
                    chunkIds.push(record[0].longValue);
                    texts.push(record[1].stringValue);
                }
            });
        }
    }
    // Queue for embeddings if configured
    if (EMBEDDING_QUEUE_URL && chunkIds.length > 0) {
        await sqsClient.send(new client_sqs_1.SendMessageCommand({
            QueueUrl: EMBEDDING_QUEUE_URL,
            MessageBody: JSON.stringify({
                itemId,
                chunkIds,
                texts
            })
        }));
        // Update status
        await rdsClient.send(new client_rds_data_1.ExecuteStatementCommand({
            resourceArn: DATABASE_RESOURCE_ARN,
            secretArn: DATABASE_SECRET_ARN,
            database: DATABASE_NAME,
            sql: `UPDATE repository_items 
              SET processing_status = 'processing_embeddings',
                  updated_at = CURRENT_TIMESTAMP
              WHERE id = :itemId`,
            parameters: [createSqlParameter('itemId', itemId)]
        }));
    }
    else {
        // Update status to completed
        await rdsClient.send(new client_rds_data_1.ExecuteStatementCommand({
            resourceArn: DATABASE_RESOURCE_ARN,
            secretArn: DATABASE_SECRET_ARN,
            database: DATABASE_NAME,
            sql: `UPDATE repository_items 
              SET processing_status = 'completed',
                  updated_at = CURRENT_TIMESTAMP
              WHERE id = :itemId`,
            parameters: [createSqlParameter('itemId', itemId)]
        }));
    }
}
// Lambda handler
async function handler(event) {
    console.log('Textract completion event:', JSON.stringify(event, null, 2));
    for (const record of event.Records) {
        try {
            const message = JSON.parse(record.Sns.Message);
            const { JobId, Status, DocumentLocation, API } = message;
            console.log(`Processing Textract job: ${JobId}, Status: ${Status}, API: ${API}`);
            if (Status === 'SUCCEEDED') {
                // Get job metadata
                const metadata = await getJobMetadata(JobId);
                if (!metadata) {
                    console.error(`No metadata found for job ${JobId}`);
                    continue;
                }
                // Get extracted text
                const useAnalysis = API === 'StartDocumentAnalysis';
                const extractedText = await getDocumentText(JobId, useAnalysis);
                if (!extractedText || extractedText.trim().length === 0) {
                    console.error('No text extracted from document');
                    await rdsClient.send(new client_rds_data_1.ExecuteStatementCommand({
                        resourceArn: DATABASE_RESOURCE_ARN,
                        secretArn: DATABASE_SECRET_ARN,
                        database: DATABASE_NAME,
                        sql: `UPDATE repository_items 
                    SET processing_status = 'failed',
                        processing_error = 'No text extracted from document by Textract',
                        updated_at = CURRENT_TIMESTAMP
                    WHERE id = :itemId`,
                        parameters: [createSqlParameter('itemId', metadata.itemId)]
                    }));
                    continue;
                }
                console.log(`Extracted ${extractedText.length} characters from ${metadata.fileName}`);
                // Chunk the text
                const chunks = chunkText(extractedText);
                console.log(`Created ${chunks.length} chunks`);
                // Store chunks and queue for embeddings
                await storeAndQueueChunks(metadata.itemId, chunks);
                // Clean up the job record
                await rdsClient.send(new client_rds_data_1.ExecuteStatementCommand({
                    resourceArn: DATABASE_RESOURCE_ARN,
                    secretArn: DATABASE_SECRET_ARN,
                    database: DATABASE_NAME,
                    sql: 'DELETE FROM textract_jobs WHERE job_id = :jobId',
                    parameters: [createSqlParameter('jobId', JobId)]
                }));
            }
            else if (Status === 'FAILED') {
                console.error(`Textract job failed: ${JobId}`);
                const metadata = await getJobMetadata(JobId);
                if (metadata) {
                    await rdsClient.send(new client_rds_data_1.ExecuteStatementCommand({
                        resourceArn: DATABASE_RESOURCE_ARN,
                        secretArn: DATABASE_SECRET_ARN,
                        database: DATABASE_NAME,
                        sql: `UPDATE repository_items 
                    SET processing_status = 'failed',
                        processing_error = 'Textract processing failed',
                        updated_at = CURRENT_TIMESTAMP
                    WHERE id = :itemId`,
                        parameters: [createSqlParameter('itemId', metadata.itemId)]
                    }));
                }
            }
        }
        catch (error) {
            console.error('Error processing Textract completion:', error);
        }
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJpbmRleC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQTZSQSwwQkFxRkM7QUFqWEQsOERBQXVIO0FBQ3ZILDhEQUE4SDtBQUM5SCxvREFBb0U7QUFFcEUsTUFBTSxjQUFjLEdBQUcsSUFBSSxnQ0FBYyxDQUFDLEVBQUUsQ0FBQyxDQUFDO0FBQzlDLE1BQU0sU0FBUyxHQUFHLElBQUksK0JBQWEsQ0FBQyxFQUFFLENBQUMsQ0FBQztBQUN4QyxNQUFNLFNBQVMsR0FBRyxJQUFJLHNCQUFTLENBQUMsRUFBRSxDQUFDLENBQUM7QUFFcEMsTUFBTSxxQkFBcUIsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLHFCQUFzQixDQUFDO0FBQ2pFLE1BQU0sbUJBQW1CLEdBQUcsT0FBTyxDQUFDLEdBQUcsQ0FBQyxtQkFBb0IsQ0FBQztBQUM3RCxNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWMsQ0FBQztBQUNqRCxNQUFNLG1CQUFtQixHQUFHLE9BQU8sQ0FBQyxHQUFHLENBQUMsbUJBQW1CLENBQUM7QUFrQjVELDJDQUEyQztBQUMzQyxTQUFTLGtCQUFrQixDQUFDLElBQVksRUFBRSxLQUF1QztJQUMvRSxJQUFJLEtBQUssS0FBSyxJQUFJLEVBQUUsQ0FBQztRQUNuQixPQUFPLEVBQUUsSUFBSSxFQUFFLEtBQUssRUFBRSxFQUFFLE1BQU0sRUFBRSxJQUFJLEVBQUUsRUFBRSxDQUFDO0lBQzNDLENBQUM7SUFDRCxJQUFJLE9BQU8sS0FBSyxLQUFLLFFBQVEsRUFBRSxDQUFDO1FBQzlCLE9BQU8sRUFBRSxJQUFJLEVBQUUsS0FBSyxFQUFFLEVBQUUsV0FBVyxFQUFFLEtBQUssRUFBRSxFQUFFLENBQUM7SUFDakQsQ0FBQztJQUNELElBQUksT0FBTyxLQUFLLEtBQUssUUFBUSxFQUFFLENBQUM7UUFDOUIsT0FBTyxFQUFFLElBQUksRUFBRSxLQUFLLEVBQUUsRUFBRSxTQUFTLEVB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QUssQ0FBQyx3QkFBd0IsS0FBSyxFQUFFLENBQUMsQ0FBQztnQkFFL0MsTUFBTSxRQUFRLEdBQUcsTUFBTSxjQUFjLENBQUMsS0FBSyxDQUFDLENBQUM7Z0JBQzdDLElBQUksUUFBUSxFQUFFLENBQUM7b0JBQ2IsTUFBTSxTQUFTLENBQUMsSUFBSSxDQUNsQixJQUFJLHlDQUF1QixDQUFDO3dCQUMxQixXQUFXLEVBQUUscUJBQXFCO3dCQUNsQyxTQUFTLEVBQUUsbUJBQW1CO3dCQUM5QixRQUFRLEVBQUUsYUFBYTt3QkFDdkIsR0FBRyxFQUFFOzs7O3VDQUlvQjt3QkFDekIsVUFBVSxFQUFFLENBQUMsa0JBQWtCLENBQUMsUUFBUSxFQUFFLFFBQVEsQ0FBQyxNQUFNLENBQUMsQ0FBQztxQkFDNUQsQ0FBQyxDQUNILENBQUM7Z0JBQ0osQ0FBQztZQUNILENBQUM7UUFFSCxDQUFDO1FBQUMsT0FBTyxLQUFLLEVBQUUsQ0FBQztZQUNmLE9BQU8sQ0FBQyxLQUFLLENBQUMsdUNBQXVDLEVBQUUsS0FBSyxDQUFDLENBQUM7UUFDaEUsQ0FBQztJQUNILENBQUM7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgU05TRXZlbnQgfSBmcm9tICdhd3MtbGFtYmRhJztcbmltcG9ydCB7IFRleHRyYWN0Q2xpZW50LCBHZXREb2N1bWVudEFuYWx5c2lzQ29tbWFuZCwgR2V0RG9jdW1lbnRUZXh0RGV0ZWN0aW9uQ29tbWFuZCB9IGZyb20gJ0Bhd3Mtc2RrL2NsaWVudC10ZXh0cmFjdCc7XG5pbXBvcnQgeyBSRFNEYXRhQ2xpZW50LCBFeGVjdXRlU3RhdGVtZW50Q29tbWFuZCwgQmF0Y2hFeGVjdXRlU3RhdGVtZW50Q29tbWFuZCwgU3FsUGFyYW1ldGVyIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXJkcy1kYXRhJztcbmltcG9ydCB7IFNRU0NsaWVudCwgU2VuZE1lc3NhZ2VDb21tYW5kIH0gZnJvbSAnQGF3cy1zZGsvY2xpZW50LXNxcyc7XG5cbmNvbnN0IHRleHRyYWN0Q2xpZW50ID0gbmV3IFRleHRyYWN0Q2xpZW50KHt9KTtcbmNvbnN0IHJkc0NsaWVudCA9IG5ldyBSRFNEYXRhQ2xpZW50KHt9KTtcbmNvbnN0IHNxc0NsaWVudCA9IG5ldyBTUVNDbGllbnQoe30pO1xuXG5jb25zdCBEQVRBQkFTRV9SRVNPVVJDRV9BUk4gPSBwcm9jZXNzLmVudi5EQVRBQkFTRV9SRVNPVVJDRV9BUk4hO1xuY29uc3QgREFUQUJBU0VfU0VDUkVUX0FSTiA9IHByb2Nlc3MuZW52LkRBVEFCQVNFX1NFQ1JFVF9BUk4hO1xuY29uc3QgREFUQUJBU0VfTkFNRSA9IHByb2Nlc3MuZW52LkRBVEFCQVNFX05BTUUhO1xuY29uc3QgRU1CRURESU5HX1FVRVVFX1VSTCA9IHByb2Nlc3MuZW52LkVNQkVERElOR19RVUVVRV9VUkw7XG5cbmludGVyZmFjZSBUZXh0cmFjdE1lc3NhZ2Uge1xuICBKb2JJZDogc3RyaW5nO1xuICBTdGF0dXM6IHN0cmluZztcbiAgRG9jdW1lbnRMb2NhdGlvbjoge1xuICAgIFMzT2JqZWN0TmFtZTogc3RyaW5nO1xuICAgIFMzQnVja2V0OiBzdHJpbmc7XG4gIH07XG4gIFRpbWVzdGFtcDogbnVtYmVyO1xuICBBUEk6IHN0cmluZztcbn1cblxuaW50ZXJmYWNlIEpvYk1ldGFkYXRhIHtcbiAgaXRlbUlkOiBudW1iZXI7XG4gIGZpbGVOYW1lOiBzdHJpbmc7XG59XG5cbi8vIEhlbHBlciBmdW5jdGlvbiB0byBjcmVhdGUgU1FMIHBhcmFtZXRlcnNcbmZ1bmN0aW9uIGNyZWF0ZVNxbFBhcmFtZXRlcihuYW1lOiBzdHJpbmcsIHZhbHVlOiBzdHJpbmcgfCBudW1iZXIgfCBib29sZWFuIHwgbnVsbCk6IFNxbFBhcmFtZXRlciB7XG4gIGlmICh2YWx1ZSA9PT0gbnVsbCkge1xuICAgIHJldHVybiB7IG5hbWUsIHZhbHVlOiB7IGlzTnVsbDogdHJ1ZSB9IH07XG4gIH1cbiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ3N0cmluZycpIHtcbiAgICByZXR1cm4geyBuYW1lLCB2YWx1ZTogeyBzdHJpbmdWYWx1ZTogdmFsdWUgfSB9O1xuICB9XG4gIGlmICh0eXBlb2YgdmFsdWUgPT09ICdudW1iZXInKSB7XG4gICAgcmV0dXJuIHsgbmFtZSwgdmFsdWU6IHsgbG9uZ1ZhbHVlOiB2YWx1ZSB9IH07XG4gIH1cbiAgaWYgKHR5cGVvZiB2YWx1ZSA9PT0gJ2Jvb2xlYW4nKSB7XG4gICAgcmV0dXJuIHsgbmFtZSwgdmFsdWU6IHsgYm9vbGVhblZhbHVlOiB2YWx1ZSB9IH07XG4gIH1cbiAgdGhyb3cgbmV3IEVycm9yKGBVbnN1cHBvcnRlZCBwYXJhbWV0ZXIgdHlwZSBmb3IgJHtuYW1lfTogJHt0eXBlb2YgdmFsdWV9YCk7XG59XG5cbi8vIEdldCBqb2IgbWV0YWRhdGEgZnJvbSBEeW5hbW9EQiBvciBSRFNcbmFzeW5jIGZ1bmN0aW9uIGdldEpvYk1ldGFkYXRhKGpvYklkOiBzdHJpbmcpOiBQcm9taXNlPEpvYk1ldGFkYXRhIHwgbnVsbD4ge1xuICB0cnkge1xuICAgIGNvbnN0IHNxbCA9IGBcbiAgICAgIFNFTEVDVCBpdGVtX2lkLCBmaWxlX25hbWUgXG4gICAgICBGUk9NIHRleHRyYWN0X2pvYnMgXG4gICAgICBXSEVSRSBqb2JfaWQgPSA6am9iSWRcbiAgICBgO1xuICAgIFxuICAgIGNvbnN0IHJlc3VsdCA9IGF3YWl0IHJkc0NsaWVudC5zZW5kKFxuICAgICAgbmV3IEV4ZWN1dGVTdGF0ZW1lbnRDb21tYW5kKHtcbiAgICAgICAgcmVzb3VyY2VBcm46IERBVEFCQVNFX1JFU09VUkNFX0FSTixcbiAgICAgICAgc2VjcmV0QXJuOiBEQVRBQkFTRV9TRUNSRVRfQVJOLFxuICAgICAgICBkYXRhYmFzZTogREFUQUJBU0VfTkFNRSxcbiAgICAgICAgc3FsLFxuICAgICAgICBwYXJhbWV0ZXJzOiBbY3JlYXRlU3FsUGFyYW1ldGVyKCdqb2JJZCcsIGpvYklkKV1cbiAgICAgIH0pXG4gICAgKTtcbiAgICBcbiAgICBpZiAocmVzdWx0LnJlY29yZHMgJiYgcmVzdWx0LnJlY29yZHMubGVuZ3RoID4gMCkge1xuICAgICAgY29uc3QgcmVjb3JkID0gcmVzdWx0LnJlY29yZHNbMF07XG4gICAgICByZXR1cm4ge1xuICAgICAgICBpdGVtSWQ6IHJlY29yZFswXT8ubG9uZ1ZhbHVlIHx8IDAsXG4gICAgICAgIGZpbGVOYW1lOiByZWNvcmRbMV0/LnN0cmluZ1ZhbHVlIHx8ICcnXG4gICAgICB9O1xuICAgIH1cbiAgICBcbiAgICByZXR1cm4gbnVsbDtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBnZXR0aW5nIGpvYiBtZXRhZGF0YTonLCBlcnJvcik7XG4gICAgcmV0dXJuIG51bGw7XG4gIH1cbn1cblxuLy8gR2V0IGRvY3VtZW50IHRleHQgZnJvbSBUZXh0cmFjdFxuYXN5bmMgZnVuY3Rpb24gZ2V0RG9jdW1lbnRUZXh0KGpvYklkOiBzdHJpbmcsIHVzZUFuYWx5c2lzOiBib29sZWFuID0gdHJ1ZSk6IFByb21pc2U8c3RyaW5nPiB7XG4gIGxldCBuZXh0VG9rZW46IHN0cmluZyB8IHVuZGVmaW5lZDtcbiAgbGV0IGZ1bGxUZXh0ID0gJyc7XG4gIFxuICBkbyB7XG4gICAgdHJ5IHtcbiAgICAgIGxldCByZXNwb25zZTtcbiAgICAgIFxuICAgICAgaWYgKHVzZUFuYWx5c2lzKSB7XG4gICAgICAgIHJlc3BvbnNlID0gYXdhaXQgdGV4dHJhY3RDbGllbnQuc2VuZChcbiAgICAgICAgICBuZXcgR2V0RG9jdW1lbnRBbmFseXNpc0NvbW1hbmQoe1xuICAgICAgICAgICAgSm9iSWQ6IGpvYklkLFxuICAgICAgICAgICAgTmV4dFRva2VuOiBuZXh0VG9rZW5cbiAgICAgICAgICB9KVxuICAgICAgICApO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgcmVzcG9uc2UgPSBhd2FpdCB0ZXh0cmFjdENsaWVudC5zZW5kKFxuICAgICAgICAgIG5ldyBHZXREb2N1bWVudFRleHREZXRlY3Rpb25Db21tYW5kKHtcbiAgICAgICAgICAgIEpvYklkOiBqb2JJZCxcbiAgICAgICAgICAgIE5leHRUb2tlbjogbmV4dFRva2VuXG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgIH1cbiAgICAgIFxuICAgICAgLy8gRXh0cmFjdCB0ZXh0IGZyb20gYmxvY2tzXG4gICAgICBpZiAocmVzcG9uc2UuQmxvY2tzKSB7XG4gICAgICAgIGZvciAoY29uc3QgYmxvY2sgb2YgcmVzcG9uc2UuQmxvY2tzKSB7XG4gICAgICAgICAgaWYgKGJsb2NrLkJsb2NrVHlwZSA9PT0gJ0xJTkUnICYmIGJsb2NrLlRleHQpIHtcbiAgICAgICAgICAgIGZ1bGxUZXh0ICs9IGJsb2NrLlRleHQgKyAnXFxuJztcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIFxuICAgICAgbmV4dFRva2VuID0gcmVzcG9uc2UuTmV4dFRva2VuO1xuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBnZXR0aW5nIGRvY3VtZW50IHRleHQ6JywgZXJyb3IpO1xuICAgICAgYnJlYWs7XG4gICAgfVxuICB9IHdoaWxlIChuZXh0VG9rZW4pO1xuICBcbiAgcmV0dXJuIGZ1bGxUZXh0LnRyaW0oKTtcbn1cblxuLy8gQ2h1bmsgdGV4dCAoc2FtZSBhcyBmaWxlLXByb2Nlc3NvcilcbmZ1bmN0aW9uIGNodW5rVGV4dCh0ZXh0OiBzdHJpbmcsIG1heENodW5rU2l6ZTogbnVtYmVyID0gMjAwMCk6IEFycmF5PHtcbiAgY29udGVudDogc3RyaW5nO1xuICBtZXRhZGF0YTogUmVjb3JkPHN0cmluZywgYW55PjtcbiAgY2h1bmtJbmRleDogbnVtYmVyO1xuICB0b2tlbnM/OiBudW1iZXI7XG59PiB7XG4gIGNvbnN0IGNodW5rczogQXJyYXk8e1xuICAgIGNvbnRlbnQ6IHN0cmluZztcbiAgICBtZXRhZGF0YTogUmVjb3JkPHN0cmluZywgYW55PjtcbiAgICBjaHVua0luZGV4OiBudW1iZXI7XG4gICAgdG9rZW5zPzogbnVtYmVyO1xuICB9PiA9IFtdO1xuICBcbiAgY29uc3QgbGluZXMgPSB0ZXh0LnNwbGl0KCdcXG4nKTtcbiAgbGV0IGN1cnJlbnRDaHVuayA9ICcnO1xuICBsZXQgY2h1bmtJbmRleCA9IDA7XG4gIFxuICBmb3IgKGNvbnN0IGxpbmUgb2YgbGluZXMpIHtcbiAgICBpZiAoKGN1cnJlbnRDaHVuayArIGxpbmUpLmxlbmd0aCA+IG1heENodW5rU2l6ZSAmJiBjdXJyZW50Q2h1bmsubGVuZ3RoID4gMCkge1xuICAgICAgY2h1bmtzLnB1c2goe1xuICAgICAgICBjb250ZW50OiBjdXJyZW50Q2h1bmsudHJpbSgpLFxuICAgICAgICBtZXRhZGF0YTogeyBsaW5lU3RhcnQ6IGNodW5rSW5kZXggfSxcbiAgICAgICAgY2h1bmtJbmRleDogY2h1bmtzLmxlbmd0aCxcbiAgICAgICAgdG9rZW5zOiBNYXRoLmNlaWwoY3VycmVudENodW5rLmxlbmd0aCAvIDQpLCAvLyBSb3VnaCB0b2tlbiBlc3RpbWF0ZVxuICAgICAgfSk7XG4gICAgICBjdXJyZW50Q2h1bmsgPSBsaW5lICsgJ1xcbic7XG4gICAgfSBlbHNlIHtcbiAgICAgIGN1cnJlbnRDaHVuayArPSBsaW5lICsgJ1xcbic7XG4gICAgfVxuICB9XG4gIFxuICBpZiAoY3VycmVudENodW5rLnRyaW0oKS5sZW5ndGggPiAwKSB7XG4gICAgY2h1bmtzLnB1c2goe1xuICAgICAgY29udGVudDogY3VycmVudENodW5rLnRyaW0oKSxcbiAgICAgIG1ldGFkYXRhOiB7IGxpbmVTdGFydDogY2h1bmtJbmRleCB9LFxuICAgICAgY2h1bmtJbmRleDogY2h1bmtzLmxlbmd0aCxcbiAgICAgIHRva2VuczogTWF0aC5jZWlsKGN1cnJlbnRDaHVuay5sZW5ndGggLyA0KSxcbiAgICB9KTtcbiAgfVxuICBcbiAgcmV0dXJuIGNodW5rcztcbn1cblxuLy8gU3RvcmUgY2h1bmtzIGFuZCBxdWV1ZSBmb3IgZW1iZWRkaW5ncyAoc2ltaWxhciB0byBmaWxlLXByb2Nlc3NvcilcbmFzeW5jIGZ1bmN0aW9uIHN0b3JlQW5kUXVldWVDaHVua3MoaXRlbUlkOiBudW1iZXIsIGNodW5rczogYW55W10pOiBQcm9taXNlPHZvaWQ+IHtcbiAgaWYgKGNodW5rcy5sZW5ndGggPT09IDApIHJldHVybjtcbiAgXG4gIC8vIEZpcnN0LCBkZWxldGUgZXhpc3RpbmcgY2h1bmtzXG4gIGF3YWl0IHJkc0NsaWVudC5zZW5kKFxuICAgIG5ldyBFeGVjdXRlU3RhdGVtZW50Q29tbWFuZCh7XG4gICAgICByZXNvdXJjZUFybjogREFUQUJBU0VfUkVTT1VSQ0VfQVJOLFxuICAgICAgc2VjcmV0QXJuOiBEQVRBQkFTRV9TRUNSRVRfQVJOLFxuICAgICAgZGF0YWJhc2U6IERBVEFCQVNFX05BTUUsXG4gICAgICBzcWw6ICdERUxFVEUgRlJPTSByZXBvc2l0b3J5X2l0ZW1fY2h1bmtzIFdIRVJFIGl0ZW1faWQgPSA6aXRlbUlkJyxcbiAgICAgIHBhcmFtZXRlcnM6IFtjcmVhdGVTcWxQYXJhbWV0ZXIoJ2l0ZW1JZCcsIGl0ZW1JZCldLFxuICAgIH0pXG4gICk7XG4gIFxuICBjb25zdCBjaHVua0lkczogbnVtYmVyW10gPSBbXTtcbiAgY29uc3QgdGV4dHM6IHN0cmluZ1tdID0gW107XG4gIFxuICAvLyBCYXRjaCBpbnNlcnQgbmV3IGNodW5rc1xuICBjb25zdCBwYXJhbWV0ZXJTZXRzOiBTcWxQYXJhbWV0ZXJbXVtdID0gY2h1bmtzLm1hcChjaHVuayA9PiBbXG4gICAgY3JlYXRlU3FsUGFyYW1ldGVyKCdpdGVtSWQnLCBpdGVtSWQpLFxuICAgIGNyZWF0ZVNxbFBhcmFtZXRlcignY29udGVudCcsIGNodW5rLmNvbnRlbnQpLFxuICAgIGNyZWF0ZVNxbFBhcmFtZXRlcignbWV0YWRhdGEnLCBKU09OLnN0cmluZ2lmeShjaHVuay5tZXRhZGF0YSkpLFxuICAgIGNyZWF0ZVNxbFBhcmFtZXRlcignY2h1bmtJbmRleCcsIGNodW5rLmNodW5rSW5kZXgpLFxuICAgIGNyZWF0ZVNxbFBhcmFtZXRlcigndG9rZW5zJywgY2h1bmsudG9rZW5zID8/IG51bGwpLFxuICBdKTtcbiAgXG4gIGNvbnN0IGJhdGNoU2l6ZSA9IDI1O1xuICBmb3IgKGxldCBpID0gMDsgaSA8IHBhcmFtZXRlclNldHMubGVuZ3RoOyBpICs9IGJhdGNoU2l6ZSkge1xuICAgIGNvbnN0IGJhdGNoID0gcGFyYW1ldGVyU2V0cy5zbGljZShpLCBpICsgYmF0Y2hTaXplKTtcbiAgICBcbiAgICBhd2FpdCByZHNDbGllbnQuc2VuZChcbiAgICAgIG5ldyBCYXRjaEV4ZWN1dGVTdGF0ZW1lbnRDb21tYW5kKHtcbiAgICAgICAgcmVzb3VyY2VBcm46IERBVEFCQVNFX1JFU09VUkNFX0FSTixcbiAgICAgICAgc2VjcmV0QXJuOiBEQVRBQkFTRV9TRUNSRVRfQVJOLFxuICAgICAgICBkYXRhYmFzZTogREFUQUJBU0VfTkFNRSxcbiAgICAgICAgc3FsOiBgSU5TRVJUIElOVE8gcmVwb3NpdG9yeV9pdGVtX2NodW5rcyBcbiAgICAgICAgICAgICAgKGl0ZW1faWQsIGNvbnRlbnQsIG1ldGFkYXRhLCBjaHVua19pbmRleCwgdG9rZW5zKVxuICAgICAgICAgICAgICBWQUxVRVMgKDppdGVtSWQsIDpjb250ZW50LCA6bWV0YWRhdGE6Ompzb25iLCA6Y2h1bmtJbmRleCwgOnRva2VucylgLFxuICAgICAgICBwYXJhbWV0ZXJTZXRzOiBiYXRjaCxcbiAgICAgIH0pXG4gICAgKTtcbiAgICBcbiAgICAvLyBRdWVyeSBmb3IgdGhlIGluc2VydGVkIElEc1xuICAgIGNvbnN0IGNodW5rUmVzdWx0ID0gYXdhaXQgcmRzQ2xpZW50LnNlbmQoXG4gICAgICBuZXcgRXhlY3V0ZVN0YXRlbWVudENvbW1hbmQoe1xuICAgICAgICByZXNvdXJjZUFybjogREFUQUJBU0VfUkVTT1VSQ0VfQVJOLFxuICAgICAgICBzZWNyZXRBcm46IERBVEFCQVNFX1NFQ1JFVF9BUk4sXG4gICAgICAgIGRhdGFiYXNlOiBEQVRBQkFTRV9OQU1FLFxuICAgICAgICBzcWw6IGBTRUxFQ1QgaWQsIGNvbnRlbnQgRlJPTSByZXBvc2l0b3J5X2l0ZW1fY2h1bmtzIFxuICAgICAgICAgICAgICBXSEVSRSBpdGVtX2lkID0gOml0ZW1JZCBcbiAgICAgICAgICAgICAgQU5EIGNodW5rX2luZGV4ID49IDpzdGFydEluZGV4IFxuICAgICAgICAgICAgICBBTkQgY2h1bmtfaW5kZXggPCA6ZW5kSW5kZXhcbiAgICAgICAgICAgICAgT1JERVIgQlkgY2h1bmtfaW5kZXhgLFxuICAgICAgICBwYXJhbWV0ZXJzOiBbXG4gICAgICAgICAgY3JlYXRlU3FsUGFyYW1ldGVyKCdpdGVtSWQnLCBpdGVtSWQpLFxuICAgICAgICAgIGNyZWF0ZVNxbFBhcmFtZXRlcignc3RhcnRJbmRleCcsIGkpLFxuICAgICAgICAgIGNyZWF0ZVNxbFBhcmFtZXRlcignZW5kSW5kZXgnLCBpICsgYmF0Y2gubGVuZ3RoKVxuICAgICAgICBdXG4gICAgICB9KVxuICAgICk7XG4gICAgXG4gICAgaWYgKGNodW5rUmVzdWx0LnJlY29yZHMpIHtcbiAgICAgIGNodW5rUmVzdWx0LnJlY29yZHMuZm9yRWFjaChyZWNvcmQgPT4ge1xuICAgICAgICBpZiAocmVjb3JkWzBdPy5sb25nVmFsdWUgJiYgcmVjb3JkWzFdPy5zdHJpbmdWYWx1ZSkge1xuICAgICAgICAgIGNodW5rSWRzLnB1c2gocmVjb3JkWzBdLmxvbmdWYWx1ZSk7XG4gICAgICAgICAgdGV4dHMucHVzaChyZWNvcmRbMV0uc3RyaW5nVmFsdWUpO1xuICAgICAgICB9XG4gICAgICB9KTtcbiAgICB9XG4gIH1cbiAgXG4gIC8vIFF1ZXVlIGZvciBlbWJlZGRpbmdzIGlmIGNvbmZpZ3VyZWRcbiAgaWYgKEVNQkVERElOR19RVUVVRV9VUkwgJiYgY2h1bmtJZHMubGVuZ3RoID4gMCkge1xuICAgIGF3YWl0IHNxc0NsaWVudC5zZW5kKFxuICAgICAgbmV3IFNlbmRNZXNzYWdlQ29tbWFuZCh7XG4gICAgICAgIFF1ZXVlVXJsOiBFTUJFRERJTkdfUVVFVUVfVVJMLFxuICAgICAgICBNZXNzYWdlQm9keTogSlNPTi5zdHJpbmdpZnkoe1xuICAgICAgICAgIGl0ZW1JZCxcbiAgICAgICAgICBjaHVua0lkcyxcbiAgICAgICAgICB0ZXh0c1xuICAgICAgICB9KVxuICAgICAgfSlcbiAgICApO1xuICAgIFxuICAgIC8vIFVwZGF0ZSBzdGF0dXNcbiAgICBhd2FpdCByZHNDbGllbnQuc2VuZChcbiAgICAgIG5ldyBFeGVjdXRlU3RhdGVtZW50Q29tbWFuZCh7XG4gICAgICAgIHJlc291cmNlQXJuOiBEQVRBQkFTRV9SRVNPVVJDRV9BUk4sXG4gICAgICAgIHNlY3JldEFybjogREFUQUJBU0VfU0VDUkVUX0FSTixcbiAgICAgICAgZGF0YWJhc2U6IERBVEFCQVNFX05BTUUsXG4gICAgICAgIHNxbDogYFVQREFURSByZXBvc2l0b3J5X2l0ZW1zIFxuICAgICAgICAgICAgICBTRVQgcHJvY2Vzc2luZ19zdGF0dXMgPSAncHJvY2Vzc2luZ19lbWJlZGRpbmdzJyxcbiAgICAgICAgICAgICAgICAgIHVwZGF0ZWRfYXQgPSBDVVJSRU5UX1RJTUVTVEFNUFxuICAgICAgICAgICAgICBXSEVSRSBpZCA9IDppdGVtSWRgLFxuICAgICAgICBwYXJhbWV0ZXJzOiBbY3JlYXRlU3FsUGFyYW1ldGVyKCdpdGVtSWQnLCBpdGVtSWQpXVxuICAgICAgfSlcbiAgICApO1xuICB9IGVsc2Uge1xuICAgIC8vIFVwZGF0ZSBzdGF0dXMgdG8gY29tcGxldGVkXG4gICAgYXdhaXQgcmRzQ2xpZW50LnNlbmQoXG4gICAgICBuZXcgRXhlY3V0ZVN0YXRlbWVudENvbW1hbmQoe1xuICAgICAgICByZXNvdXJjZUFybjogREFUQUJBU0VfUkVTT1VSQ0VfQVJOLFxuICAgICAgICBzZWNyZXRBcm46IERBVEFCQVNFX1NFQ1JFVF9BUk4sXG4gICAgICAgIGRhdGFiYXNlOiBEQVRBQkFTRV9OQU1FLFxuICAgICAgICBzcWw6IGBVUERBVEUgcmVwb3NpdG9yeV9pdGVtcyBcbiAgICAgICAgICAgICAgU0VUIHByb2Nlc3Npbmdfc3RhdHVzID0gJ2NvbXBsZXRlZCcsXG4gICAgICAgICAgICAgICAgICB1cGRhdGVkX2F0ID0gQ1VSUkVOVF9USU1FU1RBTVBcbiAgICAgICAgICAgICAgV0hFUkUgaWQgPSA6aXRlbUlkYCxcbiAgICAgICAgcGFyYW1ldGVyczogW2NyZWF0ZVNxbFBhcmFtZXRlcignaXRlbUlkJywgaXRlbUlkKV1cbiAgICAgIH0pXG4gICAgKTtcbiAgfVxufVxuXG4vLyBMYW1iZGEgaGFuZGxlclxuZXhwb3J0IGFzeW5jIGZ1bmN0aW9uIGhhbmRsZXIoZXZlbnQ6IFNOU0V2ZW50KSB7XG4gIGNvbnNvbGUubG9nKCdUZXh0cmFjdCBjb21wbGV0aW9uIGV2ZW50OicsIEpTT04uc3RyaW5naWZ5KGV2ZW50LCBudWxsLCAyKSk7XG4gIFxuICBmb3IgKGNvbnN0IHJlY29yZCBvZiBldmVudC5SZWNvcmRzKSB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnN0IG1lc3NhZ2U6IFRleHRyYWN0TWVzc2FnZSA9IEpTT04ucGFyc2UocmVjb3JkLlNucy5NZXNzYWdlKTtcbiAgICAgIGNvbnN0IHsgSm9iSWQsIFN0YXR1cywgRG9jdW1lbnRMb2NhdGlvbiwgQVBJIH0gPSBtZXNzYWdlO1xuICAgICAgXG4gICAgICBjb25zb2xlLmxvZyhgUHJvY2Vzc2luZyBUZXh0cmFjdCBqb2I6ICR7Sm9iSWR9LCBTdGF0dXM6ICR7U3RhdHVzfSwgQVBJOiAke0FQSX1gKTtcbiAgICAgIFxuICAgICAgaWYgKFN0YXR1cyA9PT0gJ1NVQ0NFRURFRCcpIHtcbiAgICAgICAgLy8gR2V0IGpvYiBtZXRhZGF0YVxuICAgICAgICBjb25zdCBtZXRhZGF0YSA9IGF3YWl0IGdldEpvYk1ldGFkYXRhKEpvYklkKTtcbiAgICAgICAgaWYgKCFtZXRhZGF0YSkge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoYE5vIG1ldGFkYXRhIGZvdW5kIGZvciBqb2IgJHtKb2JJZH1gKTtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgLy8gR2V0IGV4dHJhY3RlZCB0ZXh0XG4gICAgICAgIGNvbnN0IHVzZUFuYWx5c2lzID0gQVBJID09PSAnU3RhcnREb2N1bWVudEFuYWx5c2lzJztcbiAgICAgICAgY29uc3QgZXh0cmFjdGVkVGV4dCA9IGF3YWl0IGdldERvY3VtZW50VGV4dChKb2JJZCwgdXNlQW5hbHlzaXMpO1xuICAgICAgICBcbiAgICAgICAgaWYgKCFleHRyYWN0ZWRUZXh0IHx8IGV4dHJhY3RlZFRleHQudHJpbSgpLmxlbmd0aCA9PT0gMCkge1xuICAgICAgICAgIGNvbnNvbGUuZXJyb3IoJ05vIHRleHQgZXh0cmFjdGVkIGZyb20gZG9jdW1lbnQnKTtcbiAgICAgICAgICBhd2FpdCByZHNDbGllbnQuc2VuZChcbiAgICAgICAgICAgIG5ldyBFeGVjdXRlU3RhdGVtZW50Q29tbWFuZCh7XG4gICAgICAgICAgICAgIHJlc291cmNlQXJuOiBEQVRBQkFTRV9SRVNPVVJDRV9BUk4sXG4gICAgICAgICAgICAgIHNlY3JldEFybjogREFUQUJBU0VfU0VDUkVUX0FSTixcbiAgICAgICAgICAgICAgZGF0YWJhc2U6IERBVEFCQVNFX05BTUUsXG4gICAgICAgICAgICAgIHNxbDogYFVQREFURSByZXBvc2l0b3J5X2l0ZW1zIFxuICAgICAgICAgICAgICAgICAgICBTRVQgcHJvY2Vzc2luZ19zdGF0dXMgPSAnZmFpbGVkJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3NpbmdfZXJyb3IgPSAnTm8gdGV4dCBleHRyYWN0ZWQgZnJvbSBkb2N1bWVudCBieSBUZXh0cmFjdCcsXG4gICAgICAgICAgICAgICAgICAgICAgICB1cGRhdGVkX2F0ID0gQ1VSUkVOVF9USU1FU1RBTVBcbiAgICAgICAgICAgICAgICAgICAgV0hFUkUgaWQgPSA6aXRlbUlkYCxcbiAgICAgICAgICAgICAgcGFyYW1ldGVyczogW2NyZWF0ZVNxbFBhcmFtZXRlcignaXRlbUlkJywgbWV0YWRhdGEuaXRlbUlkKV1cbiAgICAgICAgICAgIH0pXG4gICAgICAgICAgKTtcbiAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgfVxuICAgICAgICBcbiAgICAgICAgY29uc29sZS5sb2coYEV4dHJhY3RlZCAke2V4dHJhY3RlZFRleHQubGVuZ3RofSBjaGFyYWN0ZXJzIGZyb20gJHttZXRhZGF0YS5maWxlTmFtZX1gKTtcbiAgICAgICAgXG4gICAgICAgIC8vIENodW5rIHRoZSB0ZXh0XG4gICAgICAgIGNvbnN0IGNodW5rcyA9IGNodW5rVGV4dChleHRyYWN0ZWRUZXh0KTtcbiAgICAgICAgY29uc29sZS5sb2coYENyZWF0ZWQgJHtjaHVua3MubGVuZ3RofSBjaHVua3NgKTtcbiAgICAgICAgXG4gICAgICAgIC8vIFN0b3JlIGNodW5rcyBhbmQgcXVldWUgZm9yIGVtYmVkZGluZ3NcbiAgICAgICAgYXdhaXQgc3RvcmVBbmRRdWV1ZUNodW5rcyhtZXRhZGF0YS5pdGVtSWQsIGNodW5rcyk7XG4gICAgICAgIFxuICAgICAgICAvLyBDbGVhbiB1cCB0aGUgam9iIHJlY29yZFxuICAgICAgICBhd2FpdCByZHNDbGllbnQuc2VuZChcbiAgICAgICAgICBuZXcgRXhlY3V0ZVN0YXRlbWVudENvbW1hbmQoe1xuICAgICAgICAgICAgcmVzb3VyY2VBcm46IERBVEFCQVNFX1JFU09VUkNFX0FSTixcbiAgICAgICAgICAgIHNlY3JldEFybjogREFUQUJBU0VfU0VDUkVUX0FSTixcbiAgICAgICAgICAgIGRhdGFiYXNlOiBEQVRBQkFTRV9OQU1FLFxuICAgICAgICAgICAgc3FsOiAnREVMRVRFIEZST00gdGV4dHJhY3Rfam9icyBXSEVSRSBqb2JfaWQgPSA6am9iSWQnLFxuICAgICAgICAgICAgcGFyYW1ldGVyczogW2NyZWF0ZVNxbFBhcmFtZXRlcignam9iSWQnLCBKb2JJZCldXG4gICAgICAgICAgfSlcbiAgICAgICAgKTtcbiAgICAgICAgXG4gICAgICB9IGVsc2UgaWYgKFN0YXR1cyA9PT0gJ0ZBSUxFRCcpIHtcbiAgICAgICAgY29uc29sZS5lcnJvcihgVGV4dHJhY3Qgam9iIGZhaWxlZDogJHtKb2JJZH1gKTtcbiAgICAgICAgXG4gICAgICAgIGNvbnN0IG1ldGFkYXRhID0gYXdhaXQgZ2V0Sm9iTWV0YWRhdGEoSm9iSWQpO1xuICAgICAgICBpZiAobWV0YWRhdGEpIHtcbiAgICAgICAgICBhd2FpdCByZHNDbGllbnQuc2VuZChcbiAgICAgICAgICAgIG5ldyBFeGVjdXRlU3RhdGVtZW50Q29tbWFuZCh7XG4gICAgICAgICAgICAgIHJlc291cmNlQXJuOiBEQVRBQkFTRV9SRVNPVVJDRV9BUk4sXG4gICAgICAgICAgICAgIHNlY3JldEFybjogREFUQUJBU0VfU0VDUkVUX0FSTixcbiAgICAgICAgICAgICAgZGF0YWJhc2U6IERBVEFCQVNFX05BTUUsXG4gICAgICAgICAgICAgIHNxbDogYFVQREFURSByZXBvc2l0b3J5X2l0ZW1zIFxuICAgICAgICAgICAgICAgICAgICBTRVQgcHJvY2Vzc2luZ19zdGF0dXMgPSAnZmFpbGVkJyxcbiAgICAgICAgICAgICAgICAgICAgICAgIHByb2Nlc3NpbmdfZXJyb3IgPSAnVGV4dHJhY3QgcHJvY2Vzc2luZyBmYWlsZWQnLFxuICAgICAgICAgICAgICAgICAgICAgICAgdXBkYXRlZF9hdCA9IENVUlJFTlRfVElNRVNUQU1QXG4gICAgICAgICAgICAgICAgICAgIFdIRVJFIGlkID0gOml0ZW1JZGAsXG4gICAgICAgICAgICAgIHBhcmFtZXRlcnM6IFtjcmVhdGVTcWxQYXJhbWV0ZXIoJ2l0ZW1JZCcsIG1ldGFkYXRhLml0ZW1JZCldXG4gICAgICAgICAgICB9KVxuICAgICAgICAgICk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIFxuICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICBjb25zb2xlLmVycm9yKCdFcnJvciBwcm9jZXNzaW5nIFRleHRyYWN0IGNvbXBsZXRpb246JywgZXJyb3IpO1xuICAgIH1cbiAgfVxufSJdfQ==